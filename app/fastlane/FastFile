fastlane_version '2.53.1'

platform :ios do
    # iOS Lanes
    lane :pushYatuToTestFlight do
        sh("script/change_app.sh", "0", "./../../")
        build_app(scheme: "YatuDashboard", workspace: "./../ios/YatuDashboard.xcworkspace", include_bitcode: true)

        upload_to_testflight(
            app_version: version_name,
            skip_waiting_for_build_processing: true,
            reject_build_waiting_for_review: true
        )
    end

    lane :pushYatuLiteToTestFlight do
        sh("script/change_app.sh", "1", "./../../")
        build_app(scheme: "YatuLite", workspace: "./../ios/YatuDashboard.xcworkspace", include_bitcode: true)
    end

    lane :pushYatuViewerToTestFlight do
        sh("script/change_app.sh", "2", "./../../")
        build_app(scheme: "YatuViewer", workspace: "./../ios/YatuDashboard.xcworkspace", include_bitcode: true)

        upload_to_testflight(
            app_version: version_name,
            skip_waiting_for_build_processing: true,
            reject_build_waiting_for_review: true
        )
    end
end
  
platform :android do 
    desc "Build Yatu AAB"
    lane :genYatuAab do 
        sh("script/change_app.sh", "0", "./../../")

        gradle(
            task: 'bundle', 
            flavor: "Yatu",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatu.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatu",
                "android.injected.signing.key.password" => "vt8888"
            }
        )

        upload_to_play_store(track: 'internal', aab: './../android/app/build/outputs/bundle/yatuRelease/app-yatu-release.aab')
        # upload_to_play_store(track: 'production', aab: './../android/app/build/outputs/bundle/yatuRelease/app-yatu-release.aab')
    end

    desc "Build Yatu Lite AAB"
    lane :genYatuLiteAab do 
        sh("script/change_app.sh", "1", "./../../")

        gradle(
            task: 'bundle',
            flavor: "YatuLite",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatuLite.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatuLite",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
    end

    desc "Build Yatu Viewer AAB"
    lane :genYatuViewerAab do 
        sh("script/change_app.sh", "2", "./../../")

        gradle(
            task: 'bundle',
            flavor: "YatuViewer",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatuViewer.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatuViewer",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
    end

    desc "Build Yatu APK"
    lane :genYatuApk do 
        sh("script/change_app.sh", "0", "./../../")
        gradle(
            task: "assemble",
            flavor: "Yatu",
            build_type: "release",
            project_dir: './../android'
        )
    end

    desc "Build Yatu Lite APK"
    lane :genYatuLiteApk do 
        sh("script/change_app.sh", "1", "./../../")
        gradle(
            task: "assemble",
            flavor: "YatuLite",
            build_type: "release",
            project_dir: './../android'
        )
    end

    desc "Build Yatu Viewer APK"
    lane :genYatuViewerApk do
        sh("script/change_app.sh", "2", "./../../") 
        gradle(
            task: "assemble",
            flavor: "YatuViewer",
            build_type: "release",
            project_dir: './../android'
        )
    end
end
