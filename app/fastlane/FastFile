fastlane_version '2.53.1'

platform :ios do
    # iOS Lanes
    lane :genIpa do
        # ios_set_build_number(xcodeproj: "./ios/YatuDashboard.xcodeproj")
        # version_name = ios_get_build_number(xcodeproj: "./../ios/YatuDashboard.xcodeproj")
        # ios_set_version(version: version_name, xcodeproj: "./ios/YatuDashboard.xcodeproj")

        build_app(scheme: "YatuDashboard", workspace: "./../ios/YatuDashboard.xcworkspace", include_bitcode: true)
    end

    lane :pushToTestFlight do
        # ios_set_build_number(xcodeproj: "./../ios/YatuDashboard.xcodeproj")
        # version_name = ios_get_build_number(xcodeproj: "./../ios/YatuDashboard.xcodeproj")
        # ios_set_version(version: version_name, xcodeproj: "./../ios/YatuDashboard.xcodeproj")

        build_app(scheme: "YatuDashboard", workspace: "./../ios/YatuDashboard.xcworkspace", include_bitcode: true)

        upload_to_testflight(
            app_version: version_name,
            skip_waiting_for_build_processing: true,
            reject_build_waiting_for_review: true
        )
    end
end
  
platform :android do 
    desc "Build Yatu AAB"
    lane :genYatuAab do 
        sh("script/change_app.sh", "0", "./../../")

        gradle(
            task: 'bundle', 
            flavor: "Yatu",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatu.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatu",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
    end

    desc "Build Yatu Lite AAB"
    lane :genYatuLiteAab do 
        sh("script/change_app.sh", "1", "./../../")

        gradle(
            task: 'bundle',
            flavor: "YatuLite",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatuLite.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatuLite",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
    end

    desc "Build Yatu Viewer AAB"
    lane :genYatuViewerAab do 
        sh("script/change_app.sh", "2", "./../../")

        gradle(
            task: 'bundle',
            flavor: "YatuViewer",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatuViewer.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatuViewer",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
    end

    desc "Build Yatu APK"
    lane :genYatuApk do 
        sh("script/change_app.sh", "0", "./../../")
        gradle(
            task: "assemble",
            flavor: "Yatu",
            build_type: "release",
            project_dir: './../android'
        )
    end

    desc "Build Yatu Lite APK"
    lane :genYatuLiteApk do 
        sh("script/change_app.sh", "1", "./../../")
        gradle(
            task: "assemble",
            flavor: "YatuLite",
            build_type: "release",
            project_dir: './../android'
        )
    end

    desc "Build Yatu Viewer APK"
    lane :genYatuViewerApk do
        sh("script/change_app.sh", "2", "./../../") 
        gradle(
            task: "assemble",
            flavor: "YatuViewer",
            build_type: "release",
            project_dir: './../android'
        )
    end

    desc "Release for the Android production"
    lane :pushToPlayStore do

        sh("script/change_app.sh", "0", "./../../") 

        gradle(
            task: "clean", 
            project_dir: './../android'
        )

        gradle(
            task: 'bundle', 
            flavor: "Yatu",
            build_type: "release",
            project_dir: './../android', 
            properties: {
                "android.injected.signing.store.file" => ENV['PWD'] + "/../android/app/yatu.jks",
                "android.injected.signing.store.password" => "vt8888",
                "android.injected.signing.key.alias" => "yatu",
                "android.injected.signing.key.password" => "vt8888"
            }
        )
        supply(track: 'production', aab: './../android/app/build/outputs/bundle/YatuRelease/app-yatu-release.aab')
    end

    desc "Test command"
    lane :testCommand do
        sh("script/change_app.sh", "1", "./../../")
        sh("script/update_android_version.sh", "./../../")
    end
end
